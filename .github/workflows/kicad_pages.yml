name: Generate KiCad Schematics - GitHub Pages

on:
  push:
  pull_request:

jobs:
  schematics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # Important for pushing to gh-pages

      - name: Generate schematic PDFs (KiCad 9)
        run: |
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$PWD:/workspace" \
            -w /workspace \
            kicad/kicad:9.0 \
            bash -c '
              mkdir -p output
              for sch in pcb/*.kicad_sch; do
                name=$(basename "$sch" .kicad_sch)
                echo "Exporting schematic for $name"
                kicad-cli sch export pdf \
                  "$sch" \
                  --output "output/${name}-schematic.pdf"
              done
            '

      - name: Install PDF tools
        run: sudo apt-get update && sudo apt-get install -y poppler-utils

      - name: Convert PDFs to PNG
        run: |
          mkdir -p output/png
          for pdf in output/*-schematic.pdf; do
            name=$(basename "$pdf" .pdf)
            echo "Converting $pdf â†’ PNG"
            pdftoppm \
              -png \
              -r 300 \
              "$pdf" \
              "output/png/$name"
          done

      - name: Deploy to GitHub Pages
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch
          git clone --branch gh-pages https://github.com/${{ github.repository }} gh-pages || \
            git clone https://github.com/${{ github.repository }} gh-pages
          cd gh-pages

          # Clear old schematics and copy new ones
          rm -rf schematics
          mkdir -p schematics
          cp -r ../output/png/* schematics/

          # Commit and push
          git add schematics/*
          git commit -m "Update generated schematics"
          git push origin gh-pages
