name: Generate KiCad Schematics

on:
  push:
  pull_request:

jobs:
  schematics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate schematic PDFs (KiCad 9)
        run: |
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$PWD:/workspace" \
            -w /workspace \
            kicad/kicad:9.0 \
            bash -c '
              mkdir -p output
              for sch in pcb/*.kicad_sch; do
                name=$(basename "$sch" .kicad_sch)
                echo "Exporting schematic for $name"
                kicad-cli sch export pdf \
                  "$sch" \
                  --output "output/${name}-schematic.pdf"
              done
            '

      - name: Update README with schematic links
        run: |
          echo "Updating README.md"

          export SCHEMATIC_LIST=""
          for pdf in $(ls output/*-schematic.pdf | sort); do
            name=$(basename "$pdf" -schematic.pdf)
            SCHEMATIC_LIST="${SCHEMATIC_LIST}- [$name schematic]($pdf)\n"
          done

          awk '
            /<!-- SCHEMATICS_START -->/ {
              print
              printf "%s", ENVIRON["SCHEMATIC_LIST"]
              in_block=1
              next
            }
            /<!-- SCHEMATICS_END -->/ {
              in_block=0
              print
              next
            }
            !in_block { print }
          ' README.md > README.tmp

          mv README.tmp README.md

      - name: Commit README update
        if: github.event_name == 'push'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update schematic PDFs"
          file_pattern: README.md output/*.pdf
